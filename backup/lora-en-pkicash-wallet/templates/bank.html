{% extends "base.html" %}
{% block title %}PKI Cash - Bank{% endblock %}

{% set has_key = pk_issuer is not none %}
{% set has_coins = issued_coins|length > 0 %}

{% block header %}
<div class="page-header-bar">
    <div class="header-inner">
        <div class="header-top">
            <h1>
                Bank
                {% if has_key %}
                <button class="copy-inline" onclick="copyToClipboard('{{ bank_address }}', this)" title="Kopieer adres">
                    <i data-lucide="copy" style="width:16px;height:16px"></i>
                </button>
                <button class="copy-inline" onclick="doAnnounce()" title="Announce op netwerk">
                    <i data-lucide="radio" style="width:16px;height:16px"></i>
                </button>
                {% endif %}
            </h1>
            {% if has_key %}
            <div class="menu-wrapper">
                {% if pending_count %}<span class="menu-badge"></span>{% endif %}
                <button class="menu-btn" onclick="toggleMenu('bank-menu')"><i data-lucide="menu" style="width:16px;height:16px"></i> Menu</button>
                <div class="menu-dropdown" id="bank-menu">
                    <a href="#" onclick="showSection('overzicht'); return false;">Uitgegeven coins</a>
                    <a href="#" onclick="showSection('verzoeken'); return false;">
                        Verzoeken{% if pending_count %} <span class="badge badge-value" style="font-size:0.65rem;padding:0.1rem 0.4rem">{{ pending_count }}</span>{% endif %}
                    </a>
                    <a href="#" onclick="showSection('contacten'); return false;">Contacten</a>
                    <a href="#" onclick="showSection('mijn-gegevens'); return false;">Mijn contactgegevens</a>
                    <a href="#" onclick="showSection('registraties'); return false;">Registraties State Engine</a>
                    <a href="#" onclick="showInbox(); return false;">Inbox</a>
                    <a href="#" onclick="openOverlay('network-overlay'); return false;">Netwerk</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
{% if not has_key %}
<div class="activation">
    <h2>Bank activeren</h2>
    <div class="activation-step current">
        <div class="activation-step-header">
            <span class="step-indicator">1</span>
            Keypair genereren
        </div>
        <p>Genereer een keypair om te beginnen als issuer.</p>
        <form method="POST" action="{{ url_for('bank_generate_key') }}">
            <button class="btn btn-primary" type="submit">Keypair genereren</button>
        </form>
    </div>
    <div class="activation-step locked">
        <div class="activation-step-header">
            <span class="step-indicator">2</span>
            Registreren bij State Engine
        </div>
    </div>
</div>

{% elif not registered_at_engine %}
<div class="activation">
    <h2>Bank activeren</h2>
    <div class="activation-step done">
        <div class="activation-step-header">
            <span class="step-indicator">✓</span>
            Keypair gegenereerd
        </div>
    </div>
    <div class="activation-step current">
        <div class="activation-step-header">
            <span class="step-indicator">2</span>
            Registreren bij State Engine
        </div>
        <p>Deel je contactgegevens met de State Engine operator om je te registreren als issuer.</p>
        <div class="card" style="margin:0.75rem 0;padding:0.75rem">
            <div class="my-contact-field">
                <span class="my-contact-label">Adres</span>
                <button class="copy-inline" onclick="copyToClipboard('{{ bank_address }}', this)" title="Kopieer adres"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
                <span class="my-contact-value">{{ bank_address }}</span>
            </div>
            <div class="my-contact-field">
                <span class="my-contact-label">Public Key</span>
                <button class="copy-inline" onclick="copyToClipboard('{{ bank_pk }}', this)" title="Kopieer public key"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
                <span class="my-contact-value mono" style="word-break:break-all;font-size:0.75rem">{{ bank_pk }}</span>
            </div>
        </div>
        <div class="field-with-send" style="margin-top:0.75rem">
            <div class="form-group">
                <label>Engine adres (optioneel, voor LoRa)</label>
                <div class="field-with-icon">
                    <input type="text" id="step2_engine_addr" placeholder="bijv. localhost:5000">
                    {% if contacts %}
                    <button type="button" class="addressbook-btn" onclick="toggleContactPicker(this)" title="Kies uit contacten"><i data-lucide="book-user" style="width:16px;height:16px"></i></button>
                    <div class="contact-picker">
                        {% for c in contacts %}
                        <div class="contact-picker-item" data-name="{{ c.name }}" data-addr="{{ c.address }}" data-pk="{{ c.pk }}" onclick="pickContact(this, null, 'step2_engine_addr', null)">
                            <div class="cp-name">{{ c.name }}</div>
                            <div class="cp-detail">{{ c.address }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <button type="button" class="btn btn-outline send-btn" onclick="sendRegistration('step2_engine_addr')" title="Verstuur registratie naar Engine">
                <i data-lucide="send" style="width:14px;height:14px"></i>
            </button>
        </div>

        {% set pending_engine = incoming_requests|selectattr('status', 'equalto', 'pending')|selectattr('request_type', 'equalto', 'engine_register')|list %}
        {% if pending_engine %}
        <hr style="border:none;border-top:1px solid var(--border);margin:1rem 0">
        <h3 style="font-size:0.9rem;margin-bottom:0.5rem">Inkomende registratieverzoeken</h3>
        {% for req in pending_engine %}
        {% set real_idx = incoming_requests.index(req) %}
        <div style="padding:0.5rem 0;{% if not loop.last %}border-bottom:1px solid var(--border);{% endif %}">
            <div style="font-size:0.85rem;margin-bottom:0.3rem">
                <strong>{{ req.payload.engine_name|default('State Engine') }}</strong>
                <span class="mono" style="font-size:0.7rem;margin-left:0.25rem">{{ req.from_hash }}</span>
            </div>
            {% if req.payload.pk_engine %}
            <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.4rem;word-break:break-all">
                PK: {{ req.payload.pk_engine }}
            </div>
            {% endif %}
            <div style="display:flex;gap:0.5rem">
                <form method="POST" action="{{ url_for('bank_approve_request', idx=real_idx) }}" style="margin:0">
                    <button class="btn btn-success" style="padding:0.3rem 0.75rem;font-size:0.8rem">Goedkeuren</button>
                </form>
                <form method="POST" action="{{ url_for('bank_decline_request', idx=real_idx) }}" style="margin:0">
                    <button class="btn btn-outline" style="padding:0.3rem 0.75rem;font-size:0.8rem;color:var(--danger)">Weigeren</button>
                </form>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

{% else %}

<div data-section="overzicht">
    <div class="card">
        <h2 style="display:flex;justify-content:space-between;align-items:center">
            Uitgegeven coins ({{ issued_coins|length }})
            <button class="btn btn-outline" style="padding:0.3rem 0.75rem;font-size:0.8rem" onclick="openOverlay('coin-overlay')">+ Coin uitgeven</button>
        </h2>
        {% if inline_msg %}
        <div class="inline-msg">{{ inline_msg }}</div>
        {% endif %}
        {% if issued_coins %}
        <table>
            <tr><th>Tijd</th><th>Coin ID</th><th>Waarde</th><th>Ontvanger</th><th></th></tr>
            {% for c in issued_coins %}
            <tr>
                <td style="font-size:0.8rem;color:var(--text-muted);white-space:nowrap">{{ c.timestamp }}</td>
                <td class="mono" style="word-break:break-all;font-size:0.75rem">{{ c.coin_id }}</td>
                <td><span class="badge badge-value">{{ c.waarde }}</span></td>
                <td class="mono" style="word-break:break-all;font-size:0.75rem">{{ c.recipient }}</td>
                <td>
                    <span class="accordion-toggle" onclick="toggleAccordion(this)">JSON</span>
                    <div class="accordion-body">
                        <pre style="font-size:0.7rem;white-space:pre-wrap;word-break:break-all;background:var(--bg);padding:0.5rem;border-radius:var(--radius-sm);margin:0;max-height:300px;overflow-y:auto">{{ c.coin_json | tojson(indent=2) }}</pre>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Nog geen coins uitgegeven.</p>
        {% endif %}
    </div>
</div>

<div data-section="contacten" style="display:none">
    <div class="card">
        <h2 style="display:flex;justify-content:space-between;align-items:center">
            Contacten ({{ contacts|length }})
            <button class="btn btn-outline" style="padding:0.3rem 0.75rem;font-size:0.8rem" onclick="openOverlay('bank-contact-overlay')">+ Toevoegen</button>
        </h2>
        {% if contacts %}
        {% for c in contacts %}
        <div class="contact-card">
            <div class="contact-card-header" onclick="this.parentElement.classList.toggle('expanded')">
                <span class="c-name">{{ c.name }}</span>
                <span class="c-mono" style="flex:1;text-align:right">{{ c.address }}</span>
                <i data-lucide="chevron-down" style="width:16px;height:16px;color:var(--text-muted);flex-shrink:0"></i>
            </div>
            <div class="contact-card-body">
                <form method="POST" action="{{ url_for('bank_edit_contact', idx=loop.index0) }}">
                    <div class="form-group">
                        <label>Naam</label>
                        <input type="text" name="contact_name" value="{{ c.name }}" required>
                    </div>
                    <div class="form-group">
                        <label>Adres</label>
                        <input type="text" name="contact_address" value="{{ c.address }}" required>
                    </div>
                    <div class="form-group">
                        <label>Publieke sleutel</label>
                        <input type="text" name="contact_pk" value="{{ c.pk }}" placeholder="pk (hex)">
                    </div>
                    <div class="contact-actions">
                        <button class="btn btn-primary" type="submit" style="width:auto;padding:0.4rem 1rem;font-size:0.8rem">Opslaan</button>
                        <form method="POST" action="{{ url_for('bank_delete_contact', idx=loop.index0) }}" style="display:inline;margin:0" onsubmit="return confirm('Contact verwijderen?')">
                            <button class="btn-danger-text" type="submit">Verwijderen</button>
                        </form>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Nog geen contacten. Klik "+ Toevoegen" om een contact toe te voegen.</p>
        {% endif %}
    </div>

    <!-- Overlay: Contact toevoegen (Bank) -->
    <div class="overlay-backdrop" id="bank-contact-overlay">
        <div class="overlay">
            <div class="overlay-header">
                <h2>Contact toevoegen</h2>
                <button class="overlay-close" onclick="closeOverlay('bank-contact-overlay')">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('bank_add_contact') }}">
                <div class="form-group">
                    <label>Naam</label>
                    <input type="text" name="contact_name" placeholder="bijv. Wallet A" required>
                </div>
                <div class="contact-pair">
                    <div class="form-group">
                        <label>Adres</label>
                        <input type="text" name="contact_address" class="contact-addr" placeholder="adres" required>
                    </div>
                    <div class="form-group">
                        <label>Publieke sleutel</label>
                        <input type="text" name="contact_pk" class="contact-pk" placeholder="pk (hex)">
                    </div>
                </div>
                <button class="btn btn-primary" type="submit" style="margin-top:0.75rem">Opslaan</button>
            </form>
        </div>
    </div>
</div>

<div data-section="mijn-gegevens" style="display:none">
    <div class="card">
        <h2>Mijn contactgegevens</h2>
        <div class="my-contact-field">
            <span class="my-contact-label">Adres (destination hash)</span>
            <button class="copy-inline" onclick="copyToClipboard('{{ bank_address }}', this)" title="Kopieer adres"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
            <span class="my-contact-value mono" style="word-break:break-all;font-size:0.75rem">{{ bank_address }}</span>
        </div>
        <div class="my-contact-field">
            <span class="my-contact-label">Public Key (issuer)</span>
            <button class="copy-inline" onclick="copyToClipboard('{{ bank_pk }}', this)" title="Kopieer public key"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
            <span class="my-contact-value mono" style="word-break:break-all;font-size:0.75rem">{{ bank_pk }}</span>
        </div>
    </div>
</div>
{% endif %}

<!-- Overlay: Coin uitgeven -->
<div class="overlay-backdrop" id="coin-overlay">
    <div class="overlay">
        <div class="overlay-header">
            <h2>Coin uitgeven</h2>
            <button class="overlay-close" onclick="closeOverlay('coin-overlay')">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('bank_issue_coin') }}">
            <div class="form-group">
                <label>Waarde</label>
                <input type="number" name="waarde" min="1" value="1" required>
            </div>

            <hr class="overlay-divider">

            <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem">Engine</div>
            <div class="form-group">
                <label>Naam</label>
                <div class="field-with-icon">
                    <input type="text" name="engine_name" id="engine_name" placeholder="bijv. State Engine"{% if engine_address %} value="State Engine"{% endif %}>
                    {% if contacts %}
                    <button type="button" class="addressbook-btn" onclick="toggleContactPicker(this)" title="Kies uit contacten"><i data-lucide="book-user" style="width:16px;height:16px"></i></button>
                    <div class="contact-picker">
                        {% for c in contacts %}
                        <div class="contact-picker-item" data-name="{{ c.name }}" data-addr="{{ c.address }}" data-pk="{{ c.pk }}" onclick="pickContact(this, 'engine_name', 'engine_address', 'engine_pk')">
                            <div class="cp-name">{{ c.name }}</div>
                            <div class="cp-detail">{{ c.address }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="contact-pair">
                <div class="form-group">
                    <label>Adres</label>
                    <input type="text" name="engine_address" id="engine_address" class="contact-addr" placeholder="localhost:5000" {% if engine_address %}value="{{ engine_address }}"{% endif %} required>
                </div>
                <div class="form-group">
                    <label>PK</label>
                    <input type="text" name="engine_pk" id="engine_pk" class="contact-pk" placeholder="pk (hex)" {% if engine_pk %}value="{{ engine_pk }}"{% endif %} required>
                </div>
            </div>

            <hr class="overlay-divider">

            <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem">Ontvanger</div>
            <div class="form-group">
                <label>Naam</label>
                <div class="field-with-icon">
                    <input type="text" name="recipient_name" id="recipient_name" placeholder="bijv. Wallet A">
                    {% if contacts %}
                    <button type="button" class="addressbook-btn" onclick="toggleContactPicker(this)" title="Kies uit contacten"><i data-lucide="book-user" style="width:16px;height:16px"></i></button>
                    <div class="contact-picker">
                        {% for c in contacts %}
                        <div class="contact-picker-item" data-name="{{ c.name }}" data-addr="{{ c.address }}" data-pk="{{ c.pk }}" onclick="pickContact(this, 'recipient_name', 'recipient_address', 'recipient_pk')">
                            <div class="cp-name">{{ c.name }}</div>
                            <div class="cp-detail">{{ c.address }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="contact-pair">
                <div class="form-group">
                    <label>Adres</label>
                    <input type="text" name="recipient_address" id="recipient_address" class="contact-addr" placeholder="bijv. wallet_a" required>
                </div>
                <div class="form-group">
                    <label>PK</label>
                    <input type="text" name="recipient_pk" id="recipient_pk" class="contact-pk" placeholder="pk (hex)" required>
                </div>
            </div>

            <div class="checkbox-row">
                <input type="checkbox" name="save_contacts" id="save_contacts" value="1" checked>
                <label for="save_contacts" style="margin:0;font-weight:normal">Opslaan in adresboek</label>
            </div>

            <button class="btn btn-primary" type="submit" style="margin-top:1rem">Coin uitgeven</button>
        </form>
    </div>
</div>

<!-- Sectie: Verzoeken -->
<div data-section="verzoeken" style="display:none">
    <div class="card">
        <h2>Openstaande verzoeken</h2>
        {% set pending = incoming_requests|selectattr('status', 'equalto', 'pending')|list %}
        {% if pending %}
        {% for req in pending %}
        {% set real_idx = incoming_requests.index(req) %}
        {% set req_contact = '' %}
        {% for c in contacts %}
            {% if c.address == req.from_hash %}{% set req_contact = c.name %}{% endif %}
        {% endfor %}
        <div style="margin-bottom:0.75rem;padding:1rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius)">

            {% if req.request_type == 'coin_request' %}
            <div style="font-size:1rem;font-weight:700;margin-bottom:0.15rem">Aanvraag munten</div>
            {% elif req.request_type == 'engine_register' %}
            <div style="font-size:1rem;font-weight:700;margin-bottom:0.15rem">Engine registratie</div>
            {% else %}
            <div style="font-size:1rem;font-weight:700;margin-bottom:0.15rem">{{ req.request_type }}</div>
            {% endif %}
            {% if req.ts %}
            {% set ts = req.ts[:19] %}
            <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.6rem">
                {% set rd = ts[:10] %}{% set rm = rd[5:7]|int %}
                {{ rd[8:10]|int }}
                {%- if rm == 1 %} januari{% elif rm == 2 %} februari{% elif rm == 3 %} maart{% elif rm == 4 %} april{% elif rm == 5 %} mei{% elif rm == 6 %} juni{% elif rm == 7 %} juli{% elif rm == 8 %} augustus{% elif rm == 9 %} september{% elif rm == 10 %} oktober{% elif rm == 11 %} november{% elif rm == 12 %} december{% endif %}
                {{ rd[:4] }}, {{ ts[11:] }}
            </div>
            {% endif %}

            <hr style="border:none;border-top:1px solid var(--border);margin:0 0 0.6rem 0">

            {% if req.request_type == 'engine_register' %}
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.3rem">Verzoek</div>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:0.15rem 0.75rem;font-size:0.85rem;margin-bottom:0.5rem">
                {% if req.payload and req.payload.engine_name %}
                <span style="color:var(--text-muted)">Naam</span>
                <span>{{ req.payload.engine_name }}</span>
                {% endif %}
                <span style="color:var(--text-muted)">Adres</span>
                <span>{% if req_contact %}{{ req_contact }}{% else %}<span class="mono" style="font-size:0.8rem;word-break:break-all">{{ req.from_hash }}</span>{% endif %}</span>
                {% if req.payload and req.payload.pk_engine %}
                <span style="color:var(--text-muted)">Transactie PK</span>
                <span class="mono" style="font-size:0.8rem;word-break:break-all">{{ req.payload.pk_engine }}</span>
                {% endif %}
            </div>

            <hr style="border:none;border-top:1px solid var(--border);margin:0.6rem 0">

            <div style="display:flex;gap:0.75rem">
                <form method="POST" action="{{ url_for('bank_approve_request', idx=real_idx) }}" style="margin:0">
                    <button class="btn btn-success" style="padding:0.4rem 2rem;font-size:0.85rem">Goedkeuren</button>
                </form>
                <form method="POST" action="{{ url_for('bank_decline_request', idx=real_idx) }}" style="margin:0">
                    <button class="btn btn-outline" style="padding:0.4rem 2rem;font-size:0.85rem;color:var(--danger);border-color:var(--danger)">Weigeren</button>
                </form>
            </div>

            {% elif req.request_type == 'coin_request' %}
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.3rem">Gevraagd</div>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:0.15rem 0.75rem;font-size:0.85rem;margin-bottom:0.15rem">
                <span style="color:var(--text-muted)">Aantal</span>
                <span>{{ req.payload.amount }} coins</span>
                <span style="color:var(--text-muted)">Door</span>
                <span>{% if req_contact %}{{ req_contact }}{% else %}<span class="mono" style="font-size:0.8rem;word-break:break-all">{{ req.from_hash }}</span>{% endif %}</span>
                {% if req.payload.description %}
                <span style="color:var(--text-muted)">Omschrijving</span>
                <span><em>{{ req.payload.description }}</em></span>
                {% endif %}
            </div>

            <hr style="border:none;border-top:1px solid var(--border);margin:0.6rem 0">

            <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.3rem">Beslissing</div>
            <form method="POST" action="{{ url_for('bank_approve_request', idx=real_idx) }}" style="margin:0">
                <div class="form-group" style="margin-bottom:0.4rem">
                    <label style="font-size:0.85rem;color:var(--text-muted);margin:0">Aantal coins</label>
                    <input type="number" name="approve_amount" min="1" value="{{ req.payload.amount }}" style="width:80px;padding:0.3rem 0.5rem;font-size:0.85rem">
                </div>
                <div class="form-group" style="margin-bottom:0.6rem">
                    <label style="font-size:0.85rem;color:var(--text-muted);margin:0">Omschrijving</label>
                    <input type="text" name="description" maxlength="32" value="{{ req.payload.description|default('') }}" placeholder="optioneel" style="padding:0.3rem 0.5rem;font-size:0.85rem;max-width:300px">
                </div>

                <hr style="border:none;border-top:1px solid var(--border);margin:0 0 0.6rem 0">

                <div style="display:flex;gap:0.75rem">
                    <button class="btn btn-success" style="padding:0.4rem 2rem;font-size:0.85rem">Goedkeuren</button>
            </form>
                    <form method="POST" action="{{ url_for('bank_decline_request', idx=real_idx) }}" style="margin:0">
                        <button class="btn btn-outline" style="padding:0.4rem 2rem;font-size:0.85rem;color:var(--danger);border-color:var(--danger)">Weigeren</button>
                    </form>
                </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Geen openstaande verzoeken.</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>Afgehandelde verzoeken</h2>
        {% set handled = incoming_requests|rejectattr('status', 'equalto', 'pending')|list %}
        {% if handled %}
        <table>
            <tr><th>Type</th><th>Van</th><th>Status</th><th>Tijd</th></tr>
            {% for req in handled|reverse %}
            <tr>
                <td style="font-size:0.85rem">
                    {% if req.request_type == 'engine_register' %}Engine registratie
                    {% elif req.request_type == 'coin_request' %}Coin aanvraag ({{ req.payload.amount if req.payload else '?' }}x)
                    {% else %}{{ req.request_type }}{% endif %}
                </td>
                <td class="mono" style="font-size:0.75rem">{{ req.from_hash[:16] }}…</td>
                <td>
                    {% if req.status == 'approved' %}
                    <span class="badge badge-success" style="font-size:0.7rem">Goedgekeurd</span>
                    {% else %}
                    <span class="badge" style="font-size:0.7rem;background:var(--danger);color:#fff">Afgewezen</span>
                    {% endif %}
                </td>
                <td style="font-size:0.75rem;color:var(--text-muted)">{{ req.ts[:19] if req.ts else '' }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Nog geen afgehandelde verzoeken.</p>
        {% endif %}
    </div>
</div>

<!-- Sectie: Registraties State Engine -->
<div data-section="registraties" style="display:none">
    <div class="card">
        <h2>Geregistreerde engines</h2>
        {% if registered_at_engine %}
        <table>
            <tr><th>Naam</th><th>Adres</th><th>Publieke sleutel State Engine</th></tr>
            <tr>
                <td style="font-weight:500">State Engine</td>
                <td class="mono" style="font-size:0.8rem">{{ engine_address }}</td>
                <td class="mono" style="word-break:break-all;font-size:0.75rem">{{ engine_pk }}</td>
            </tr>
        </table>
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Nog niet geregistreerd bij een State Engine.</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>Registreren bij nieuwe State Engine</h2>
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">
            Deel je contactgegevens met een Engine operator om je te registreren als issuer.
        </p>
        <div class="my-contact-field">
            <span class="my-contact-label">Adres</span>
            <button class="copy-inline" onclick="copyToClipboard('{{ bank_address }}', this)" title="Kopieer adres"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
            <span class="my-contact-value">{{ bank_address }}</span>
        </div>
        {% if bank_pk %}
        <div class="my-contact-field">
            <span class="my-contact-label">Public Key</span>
            <button class="copy-inline" onclick="copyToClipboard('{{ bank_pk }}', this)" title="Kopieer public key"><i data-lucide="copy" style="width:14px;height:14px"></i></button>
            <span class="my-contact-value mono" style="word-break:break-all;font-size:0.75rem">{{ bank_pk }}</span>
        </div>
        {% endif %}

        <hr style="border:none;border-top:1px solid var(--border);margin:1rem 0">

        <div class="field-with-send">
            <div class="form-group">
                <label>Engine adres (voor LoRa)</label>
                <div class="field-with-icon">
                    <input type="text" id="reg_engine_addr" placeholder="bijv. localhost:5000">
                    {% if contacts %}
                    <button type="button" class="addressbook-btn" onclick="toggleContactPicker(this)" title="Kies uit contacten"><i data-lucide="book-user" style="width:16px;height:16px"></i></button>
                    <div class="contact-picker">
                        {% for c in contacts %}
                        <div class="contact-picker-item" data-name="{{ c.name }}" data-addr="{{ c.address }}" data-pk="{{ c.pk }}" onclick="pickContact(this, null, 'reg_engine_addr', null)">
                            <div class="cp-name">{{ c.name }}</div>
                            <div class="cp-detail">{{ c.address }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <button type="button" class="btn btn-outline send-btn" onclick="sendRegistration('reg_engine_addr')" title="Verstuur registratie naar Engine">
                <i data-lucide="send" style="width:14px;height:14px"></i>
            </button>
        </div>
    </div>
</div>

<div data-section="inbox" style="display:none">
    <h2 style="font-size:1.1rem;margin-bottom:0.75rem">Inbox</h2>
    <div id="inbox-list"></div>
</div>

{% endblock %}

{% block scripts %}
{% if has_key %}
<script>
function handleSSE(data) {
    if (data.type === 'issuer_registered') {
        fetch('/bank/confirm-engine-registration', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                engine_address: data.engine_address,
                engine_pk: data.engine_pk
            })
        }).then(() => location.reload());
    }
    if (data.type === 'new_request' || data.type === 'request_declined') {
        setTimeout(() => location.reload(), 1000);
    }
}

function sendRegistration(addrFieldId) {
    let engineDest = document.getElementById(addrFieldId).value.trim();
    if (engineDest.includes('|')) engineDest = engineDest.split('|')[0];
    if (!engineDest) {
        alert('Vul eerst het engine adres (destination hash) in.');
        return;
    }
    fetch('/bank/register-at-engine', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ engine_dest: engineDest })
    })
    .then(r => r.json())
    .then(d => {
        if (d.ok) { alert('Registratieverzoek verzonden via Reticulum!'); }
        else { alert('Fout: ' + (d.error || 'onbekend')); }
    })
    .catch(e => alert('Fout: ' + e.message));
}
</script>
{% endif %}
{% endblock %}
