{% extends "base.html" %}
{% block title %}PKI Cash - Wallet {{ wallet_id|upper }}{% endblock %}

{% set has_coins = coins|length > 0 %}

{% block header %}
<div class="page-header-bar">
    <div class="header-inner">
        <div class="header-top">
            <h1>
                Wallet {{ wallet_id|upper }}
                {% if wallet_address %}
                <button class="copy-inline" onclick="copyToClipboard('{{ wallet_address }}', this)" title="Kopieer adres">
                    <i data-lucide="copy" style="width:16px;height:16px"></i>
                </button>
                {% endif %}
            </h1>
            <div class="menu-wrapper">
                <button class="menu-btn" onclick="toggleMenu('wallet-menu')"><i data-lucide="menu" style="width:16px;height:16px"></i> Menu</button>
                <div class="menu-dropdown" id="wallet-menu">
                    <a href="#" onclick="showSection('overzicht'); return false;">Overzicht</a>
                    <a href="#" onclick="showSection('contacten'); return false;">Contacten</a>
                    <a href="#" onclick="showSection('mijn-adres'); return false;">Mijn contactgegevens</a>
                    <a href="#" onclick="showInbox(); return false;">Inbox</a>
                    <a href="#" onclick="openOverlay('network-overlay'); return false;">Netwerk</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div data-section="overzicht">
    <div class="action-buttons">
        {% if has_coins %}
        <button class="action-btn" onclick="openOverlay('pay-overlay')">
            <div class="icon-circle"><i data-lucide="send" style="width:20px;height:20px"></i></div>
            <span>Betalen</span>
        </button>
        {% endif %}
        <button class="action-btn" onclick="openOverlay('receive-overlay')">
            <div class="icon-circle green"><i data-lucide="download" style="width:20px;height:20px"></i></div>
            <span>Ontvangen</span>
        </button>
    </div>

    <div class="hero">
        <div class="balance-label">Saldo</div>
        <div class="balance">{{ balance }}</div>
    </div>

    <div class="card">
        <h2>Transacties</h2>
        {% if inline_msg %}
        <div class="inline-msg">{{ inline_msg }}</div>
        {% endif %}
        {% if transactions %}
        {% for tx in transactions %}
        {% set is_in = tx.action != 'verstuurd' %}
        <div class="tx-item">
            <div class="tx-left">
                <span class="tx-action">{{ tx.action|capitalize }}</span>
                <span class="tx-detail">{{ tx.counterparty or '' }} {{ tx.timestamp }}</span>
            </div>
            <span class="tx-amount {{ 'received' if is_in else 'sent' }}">
                {{ '+' if is_in else '-' }}{{ tx.waarde or '?' }}
            </span>
        </div>
        {% endfor %}
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Nog geen transacties.</p>
        {% endif %}
    </div>
</div>

<div data-section="contacten" style="display:none">
    <div class="card">
        <h2 style="display:flex;justify-content:space-between;align-items:center">
            Contacten ({{ contacts|length }})
            <button class="btn btn-outline" style="padding:0.3rem 0.75rem;font-size:0.8rem" onclick="openOverlay('wallet-contact-overlay')">+ Toevoegen</button>
        </h2>
        {% if contacts %}
        {% for c in contacts %}
        <div class="contact-card">
            <div class="contact-card-header" onclick="this.parentElement.classList.toggle('expanded')">
                <span class="c-name">{{ c.name }}</span>
                <span class="c-mono" style="flex:1;text-align:right">{{ c.address }}</span>
                <i data-lucide="chevron-down" style="width:16px;height:16px;color:var(--text-muted);flex-shrink:0"></i>
            </div>
            <div class="contact-card-body">
                <form method="POST" action="{{ url_for('wallet_edit_contact', wallet_id=wallet_id, idx=loop.index0) }}">
                    <div class="form-group">
                        <label>Naam</label>
                        <input type="text" name="contact_name" value="{{ c.name }}" required>
                    </div>
                    <div class="form-group">
                        <label>Adres</label>
                        <input type="text" name="contact_address" value="{{ c.address }}" required>
                    </div>
                    <div class="contact-actions">
                        <button class="btn btn-primary" type="submit" style="width:auto;padding:0.4rem 1rem;font-size:0.8rem">Opslaan</button>
                        <form method="POST" action="{{ url_for('wallet_delete_contact', wallet_id=wallet_id, idx=loop.index0) }}" style="display:inline;margin:0" onsubmit="return confirm('Contact verwijderen?')">
                            <button class="btn-danger-text" type="submit">Verwijderen</button>
                        </form>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem">Nog geen contacten. Klik "+ Toevoegen" om een contact toe te voegen.</p>
        {% endif %}
    </div>

    <!-- Overlay: Contact toevoegen (Wallet) -->
    <div class="overlay-backdrop" id="wallet-contact-overlay">
        <div class="overlay">
            <div class="overlay-header">
                <h2>Contact toevoegen</h2>
                <button class="overlay-close" onclick="closeOverlay('wallet-contact-overlay')">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('wallet_add_contact', wallet_id=wallet_id) }}">
                <div class="form-group">
                    <label>Naam</label>
                    <input type="text" name="contact_name" placeholder="bijv. Wallet B" required>
                </div>
                <div class="form-group">
                    <label>Adres</label>
                    <input type="text" name="contact_address" placeholder="bijv. wallet_b" required>
                </div>
                <button class="btn btn-primary" type="submit" style="margin-top:0.75rem">Opslaan</button>
            </form>
        </div>
    </div>
</div>

<div data-section="mijn-adres" style="display:none">
    <div class="card">
        <h2>Mijn contactgegevens</h2>
        <div class="my-contact-field">
            <span class="my-contact-label">Adres (dest hash)</span>
            <span class="my-contact-value mono" style="word-break:break-all;font-size:0.75rem">{{ wallet_address }}</span>
        </div>
        <p style="color:var(--text-muted);font-size:0.8rem;margin:0.5rem 0">
            PK transactie verandert per betaalverzoek.
        </p>
        <button class="btn btn-outline" style="margin-top:0.25rem" onclick="copyToClipboard('{{ wallet_address }}', this)">
            <i data-lucide="copy" style="width:14px;height:14px;vertical-align:middle"></i> Kopieer adres
        </button>
    </div>
</div>

<!-- Overlay: Betalen -->
<div class="overlay-backdrop" id="pay-overlay">
    <div class="overlay">
        <div class="overlay-header">
            <h2>Betalen</h2>
            <button class="overlay-close" onclick="closeOverlay('pay-overlay')">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('wallet_pay', wallet_id=wallet_id) }}">
            <div class="form-group">
                <label>Kies coin</label>
                <select name="coin_id">
                    {% for c in coins %}
                    <option value="{{ c.coin_id }}">Coin {{ loop.index }} (waarde: {{ c.waarde }})</option>
                    {% endfor %}
                </select>
            </div>

            <hr class="overlay-divider">

            <div class="form-group">
                <label>Naam ontvanger</label>
                <div class="field-with-icon">
                    <input type="text" name="recipient_name" id="pay_name" placeholder="bijv. Wallet B">
                    {% if contacts %}
                    <button type="button" class="addressbook-btn" onclick="toggleContactPicker(this)" title="Kies uit contacten"><i data-lucide="book-user" style="width:16px;height:16px"></i></button>
                    <div class="contact-picker">
                        {% for c in contacts %}
                        <div class="contact-picker-item" data-name="{{ c.name }}" data-addr="{{ c.address }}" data-pk="" onclick="pickContact(this, 'pay_name', 'pay_addr', null)">
                            <div class="cp-name">{{ c.name }}</div>
                            <div class="cp-detail">{{ c.address }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="contact-pair">
                <div class="form-group">
                    <label>Adres</label>
                    <input type="text" name="recipient_address" id="pay_addr" class="contact-addr" placeholder="bijv. wallet_b" required>
                </div>
                <div class="form-group">
                    <label>PK ontvanger</label>
                    <input type="text" name="recipient_pk" id="pay_pk" class="contact-pk" placeholder="pk van betaalverzoek" required>
                </div>
            </div>
            <div class="checkbox-row">
                <input type="checkbox" name="save_contact" id="pay_save" value="1" checked>
                <label for="pay_save" style="margin:0;font-weight:normal">Opslaan in adresboek</label>
            </div>
            <button class="btn btn-primary" type="submit" style="margin-top:1rem">Versturen</button>
        </form>
    </div>
</div>

<!-- Overlay: Ontvangen / Betaalverzoek -->
<div class="overlay-backdrop" id="receive-overlay">
    <div class="overlay">
        <div class="overlay-header">
            <h2>Betaalverzoek</h2>
            <button class="overlay-close" onclick="closeOverlay('receive-overlay')">&times;</button>
        </div>

        {% if wallet_pk %}
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">
            Je betaalgegevens zijn aangemaakt. Deel deze met de betaler.
        </p>
        <div class="card" style="margin-bottom:1rem">
            <div class="my-contact-field">
                <span class="my-contact-label">Adres</span>
                <span class="my-contact-value">{{ wallet_address }}</span>
            </div>
            <div class="my-contact-field">
                <span class="my-contact-label">Public Key</span>
                <span class="my-contact-value mono" style="word-break:break-all;font-size:0.75rem">{{ wallet_pk }}</span>
            </div>
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
                <button class="btn btn-outline" onclick="copyToClipboard('{{ wallet_address }}', this)">
                    <i data-lucide="copy" style="width:14px;height:14px;vertical-align:middle"></i> Kopieer adres
                </button>
                <button class="btn btn-outline" onclick="copyToClipboard('{{ wallet_pk }}', this)">
                    <i data-lucide="copy" style="width:14px;height:14px;vertical-align:middle"></i> Kopieer PK
                </button>
            </div>
        </div>

        <div class="field-with-send">
            <div class="form-group">
                <label>Versturen naar (optioneel)</label>
                <div class="field-with-icon">
                    <input type="text" id="recv_send_to" placeholder="bijv. wallet_b of bank">
                    {% if contacts %}
                    <button type="button" class="addressbook-btn" onclick="toggleContactPicker(this)" title="Kies uit contacten"><i data-lucide="book-user" style="width:16px;height:16px"></i></button>
                    <div class="contact-picker">
                        {% for c in contacts %}
                        <div class="contact-picker-item" data-name="{{ c.name }}" data-addr="{{ c.address }}" data-pk="" onclick="pickContact(this, null, 'recv_send_to', null)">
                            <div class="cp-name">{{ c.name }}</div>
                            <div class="cp-detail">{{ c.address }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <button type="button" class="btn btn-outline send-btn" onclick="sendPaymentRequest()" title="Verstuur via Reticulum">
                <i data-lucide="send" style="width:14px;height:14px"></i>
            </button>
        </div>

        <hr class="overlay-divider">
        <form method="POST" action="{{ url_for('wallet_request_payment', wallet_id=wallet_id) }}">
            <input type="hidden" name="wallet_address" value="{{ wallet_address }}">
            <button class="btn btn-outline" type="submit" style="width:100%">Nieuw betaalverzoek genereren</button>
        </form>

        {% else %}
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">
            Genereer een betaalverzoek om een betaling te ontvangen. Je adres en een nieuwe public key worden aangemaakt om te delen met de betaler.
        </p>
        <form method="POST" action="{{ url_for('wallet_request_payment', wallet_id=wallet_id) }}">
            <div class="form-group">
                <label>Jouw adres</label>
                <input type="text" name="wallet_address" value="{{ wallet_address }}" placeholder="bijv. mijn_wallet" required>
            </div>
            <button class="btn btn-success" type="submit">Betaalverzoek genereren</button>
        </form>
        {% endif %}
    </div>
</div>

<div data-section="inbox" style="display:none">
    <h2 style="font-size:1.1rem;margin-bottom:0.75rem">Inbox</h2>
    <div id="inbox-list"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
function handleSSE(data) {
    if (data.type === 'coin_received' || data.type === 'tx_confirmed') {
        setTimeout(() => location.reload(), 1000);
    }
}

function sendPaymentRequest() {
    const destField = document.getElementById('recv_send_to');
    let dest = destField ? destField.value.trim() : '';
    if (dest.includes('|')) dest = dest.split('|')[0];
    if (!dest) { alert('Vul eerst een dest hash in.'); return; }
    fetch('/api/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            dest_hash: dest,
            target_role: 'wallet',
            msg_type: 'payment_request',
            payload: {
                address: '{{ wallet_address }}',
                pk: '{{ wallet_pk|default("") }}'
            }
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.ok) alert('Betaalverzoek verzonden via Reticulum!');
        else alert('Fout: ' + (d.error || 'onbekend'));
    })
    .catch(e => alert('Fout: ' + e.message));
}
{% if wallet_pk %}
document.addEventListener('DOMContentLoaded', function() { openOverlay('receive-overlay'); });
{% endif %}
</script>
{% endblock %}
